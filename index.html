<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KEYLLA VIRGINA — Buku Tabungan & Ibadah</title>
<style>
:root{
  --bg:#fff0f7;--card:#ffe3f2;--accent:#ff6bd6;--muted:#b46ba1;--danger:#ff3366;
  font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
}
html,body{margin:0;padding:0;height:100%;background:linear-gradient(180deg,#ffb6f0,#ffd6f9,#fff0f7);color:#4a0044;overflow-x:hidden;}
.hidden{display:none;}
#pinScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#ff94dc,#ffd6f9);z-index:9999}
#pinBox{background:#fff0f7;padding:20px;border-radius:12px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.15)}
#pinBox input{font-size:20px;letter-spacing:8px;text-align:center;padding:10px;width:140px;border:1px solid #ff7ac6;border-radius:8px;margin-bottom:10px}
#pinBox button{padding:8px 14px;border:none;background:#ff6bd6;color:#fff;border-radius:8px;cursor:pointer}
#pinError{color:var(--danger);font-size:13px;height:16px;margin-top:6px}

/* Slides horizontal - 5 slides */
#slidesContainer{display:flex;flex-direction:row;transition:transform 0.33s ease;width:500vw;}
.slide{width:100vw;flex-shrink:0;min-height:100vh;box-sizing:border-box;padding:12px;overflow-y:auto;}
.card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);border:1px solid rgba(255,0,180,0.12)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid rgba(255,0,180,0.18);background:#fff;color:#4a0044;font-size:14px}
button{cursor:pointer;background:#ffb3e6;border:1px solid #ff7ac6;color:#4a0044}
.table{width:100%;border-collapse:collapse;margin-top:8px;}
.table th,.table td{font-size:13px;text-align:left;padding:6px;border-bottom:1px dashed rgba(255,0,180,0.18);}
.badge-income{color:#00b894;font-size:11px;padding:1px 4px;border-radius:4px;background:rgba(0,184,148,0.08);}
.badge-expense{color:var(--danger);font-size:11px;padding:1px 4px;border-radius:4px;background:rgba(255,51,102,0.08);}
.totals{font-weight:700;background:rgba(255,255,255,0.3);padding:6px;margin-top:8px}
.small{font-size:12px;color:var(--muted);}

/* Menu vertical */
.menuList{display:flex;flex-direction:column;gap:10px}
.menuList button{width:100%;text-align:left;font-size:15px;padding:12px}

/* Entry card list (optional) */
.entryCard{
  background:#fff;
  border:1px solid rgba(255,0,180,0.08);
  border-radius:8px;
  padding:10px;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.04);
}
.entryInfo{font-size:14px;flex:1}
.entryAmount{font-weight:700;margin-left:12px}
.entryActions button{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:6px}

/* tasks/sholat table small style */
.table-small td, .table-small th{padding:8px;font-size:13px}
</style>
</head>
<body>

<!-- PIN Screen -->
<div id="pinScreen">
  <div id="pinBox">
    <h2>🔒 MASUKAN PIN</h2>
    <input type="password" id="pinInput" maxlength="6" placeholder="******" inputmode="numeric" autocomplete="off">
    <br>
    <button id="pinBtn">BUKA</button>
    <div id="pinError"></div>
  </div>
</div>

<!-- App Slides -->
<div id="app" class="hidden">
  <div id="slidesContainer">

    <!-- Slide 0: Menu (vertical) -->
    <div class="slide" id="menuSlide">
      <div class="header">
        <div class="title">📖 Menu Utama</div>
        <div class="small">Pilih bagian</div>
      </div>

      <div class="card menuList">
        <button onclick="showSlide(1)">📑 Catatan Keuangan</button>
        <button onclick="showSlide(2)">💰 Tabungan</button>
        <button onclick="showSlide(3)">📚 Tugas Sekolah</button>
        <button onclick="showSlide(4)">🕌 Catatan Sholat</button>
      </div>

      <div class="card menuList">
        <button onclick="exportCSV()">⬇️ Export CSV</button>
        <button onclick="document.getElementById('fileInput').click()">⬆️ Import CSV</button>
        <small class="small">CSV mengandung semua data (keuangan, tabungan, tugas, sholat)</small>
      </div>
    </div>

    <!-- Slide 1: Catatan Keuangan (list downward optional) -->
    <div class="slide" id="slide-money">
      <div class="header">
        <div class="title">Catatan Keuangan 🎀</div>
        <div class="small">Pemasukan & Pengeluaran</div>
      </div>

      <div class="card row">
        <select id="kind" style="width:120px">
          <option value="income">Pemasukan</option>
          <option value="expense">Pengeluaran</option>
        </select>
        <input id="amount" type="number" step="0.01" min="0" placeholder="Jumlah">
        <input id="date" type="date">
        <input id="desc" type="text" placeholder="Deskripsi (opsional)">
        <button id="addBtn">Tambahkan</button>
        <button id="clearBtn1">Hapus Semua</button>
      </div>

      <!-- List ke bawah -->
      <div id="entriesList" class="card"></div>

      <div class="card totals">Total: <span id="totalAmount">0.00</span></div>
      <div class="card row"><button onclick="showSlide(0)">⬅️ Kembali ke Menu</button></div>
    </div>

    <!-- Slide 2: Tabungan -->
    <div class="slide" id="slide-savings">
      <div class="header"><div class="title">Tabungan 💰</div><div class="small">Pemasukan & Pengeluaran</div></div>

      <div class="card row">
        <select id="kind2" style="width:120px">
          <option value="income">Pemasukan</option>
          <option value="expense">Pengeluaran</option>
        </select>
        <input id="amount2" type="number" step="0.01" min="0" placeholder="Jumlah">
        <input id="date2" type="date">
        <input id="desc2" type="text" placeholder="Deskripsi (opsional)">
        <button id="addBtn2">Tambahkan</button>
        <button id="clearBtn2">Hapus Semua</button>
      </div>

      <div class="card">
        <table class="table" id="slide2Table">
          <thead><tr><th>Tanggal</th><th>Tipe</th><th>Deskripsi</th><th>Jumlah</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card totals">Total Tabungan: <span id="slide2Total">0.00</span></div>
      <div class="card row"><button onclick="showSlide(0)">⬅️ Kembali ke Menu</button></div>
    </div>

    <!-- Slide 3: Tugas Sekolah -->
    <div class="slide" id="slide-tasks">
      <div class="header"><div class="title">📚 Tugas Sekolah</div><div class="small">Tambah tugas + deadline</div></div>

      <div class="card row">
        <input id="taskTitle" type="text" placeholder="Nama tugas">
        <input id="taskDate" type="date">
        <button id="addTaskBtn">Tambah</button>
        <button id="clearTasksBtn">Hapus Semua</button>
      </div>

      <div class="card">
        <table class="table table-small" id="tasksTable">
          <thead><tr><th>Cek</th><th>Tugas</th><th>Tanggal</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card row"><button onclick="showSlide(0)">⬅️ Kembali ke Menu</button></div>
    </div>

    <!-- Slide 4: Catatan Sholat -->
<div class="slide" id="slide-pray">
  <div class="header">
    <div class="title">🕌 Catatan Sholat</div>
    <div class="small">Tandai status sholat + catatan</div>
  </div>

  <div class="card row">
    <label style="display:flex;align-items:center;gap:8px">Pilih Tanggal:
      <input id="prayDate" type="date">
    </label>
    <button id="clearPrayForDate">Reset Hari</button>
  </div>

  <div class="card">
    <table class="table table-small" id="prayTable">
      <thead>
        <tr><th>Waktu</th><th>Status</th><th>Catatan</th></tr>
      </thead>
      <tbody>
        <tr><td>Subuh</td>
          <td>
            <select id="pray_subuh">
              <option value="">-</option>
              <option value="done">✅ Sholat</option>
              <option value="missed">❌ Tidak</option>
              <option value="excused">➖ Halangan</option>
            </select>
          </td>
          <td><input type="text" id="note_subuh" placeholder="Catatan..."></td>
        </tr>
        <tr><td>Dzuhur</td>
          <td>
            <select id="pray_dzuhur">
              <option value="">-</option>
              <option value="done">✅ Sholat</option>
              <option value="missed">❌ Tidak</option>
              <option value="excused">➖ Halangan</option>
            </select>
          </td>
          <td><input type="text" id="note_dzuhur" placeholder="Catatan..."></td>
        </tr>
        <tr><td>Ashar</td>
          <td>
            <select id="pray_ashar">
              <option value="">-</option>
              <option value="done">✅ Sholat</option>
              <option value="missed">❌ Tidak</option>
              <option value="excused">➖ Halangan</option>
            </select>
          </td>
          <td><input type="text" id="note_ashar" placeholder="Catatan..."></td>
        </tr>
        <tr><td>Maghrib</td>
          <td>
            <select id="pray_maghrib">
              <option value="">-</option>
              <option value="done">✅ Sholat</option>
              <option value="missed">❌ Tidak</option>
              <option value="excused">➖ Halangan</option>
            </select>
          </td>
          <td><input type="text" id="note_maghrib" placeholder="Catatan..."></td>
        </tr>
        <tr><td>Isya</td>
          <td>
            <select id="pray_isya">
              <option value="">-</option>
              <option value="done">✅ Sholat</option>
              <option value="missed">❌ Tidak</option>
              <option value="excused">➖ Halangan</option>
            </select>
          </td>
          <td><input type="text" id="note_isya" placeholder="Catatan..."></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card row"><button onclick="showSlide(0)">⬅️ Kembali ke Menu</button></div>
</div>

  </div>
</div>

<input type="file" id="fileInput" accept=".csv" style="display:none">

<script>
/* ========== CONFIG ========== */
const PIN = "160108";
const slidesContainer = document.getElementById("slidesContainer");
const totalSlides = document.querySelectorAll(".slide").length;
let currentSlide = 0;
function showSlide(i){ currentSlide = Math.max(0, Math.min(i, totalSlides-1)); slidesContainer.style.transform = `translateX(-${currentSlide*100}vw)`; }

/* ========== HELPERS ========== */
function nowISO(d = new Date()){ return d.toISOString().slice(0,10); }
function fmtCurrency(v){ return Number(v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function toast(msg){ alert(msg); }

/* ========== STORAGE LAYERS ========== */
function loadEntries(){ try{ return JSON.parse(localStorage.getItem("glitch_money_entries_v1") || "[]"); }catch(e){return [];} }
function saveEntries(list){ localStorage.setItem("glitch_money_entries_v1", JSON.stringify(list)); }

function loadTabungan(){ try{ return JSON.parse(localStorage.getItem("glitch_saving_v1") || "[]"); }catch(e){return [];} }
function saveTabungan(list){ localStorage.setItem("glitch_saving_v1", JSON.stringify(list)); }

function loadTasks(){ try{ return JSON.parse(localStorage.getItem("glitch_tasks_v1") || "[]"); }catch(e){return [];} }
function saveTasks(list){ localStorage.setItem("glitch_tasks_v1", JSON.stringify(list)); }

function loadPray(){ try{ return JSON.parse(localStorage.getItem("glitch_sholat_v1") || "{}"); }catch(e){return {};} }
function savePray(obj){ localStorage.setItem("glitch_sholat_v1", JSON.stringify(obj)); }

/* ========== PIN ========== */
const pinScreen = document.getElementById("pinScreen");
const app = document.getElementById("app");
document.getElementById("pinBtn").addEventListener("click", ()=>{
  const v = document.getElementById("pinInput").value;
  if(v === PIN){
    pinScreen.style.display = "none";
    app.classList.remove("hidden");
    initAll();
    showSlide(0);
  } else {
    pinScreen.querySelector("#pinError").textContent = "PIN salah!";
    document.getElementById("pinInput").value = "";
  }
});

/* ========== MONEY (Slide 1) - list downward rendering ========== */
const entriesListEl = document.getElementById("entriesList");
function renderMoneyList(){
  const list = loadEntries();
  entriesListEl.innerHTML = "";
  let total = 0;
  // newest first
  list.slice().reverse().forEach(it=>{
    total += (it.kind === "income" ? Number(it.amount || 0) : -Number(it.amount || 0));
    const card = document.createElement("div");
    card.className = "entryCard";
    card.innerHTML = `
      <div class="entryInfo">
        <div><strong>${it.kind === "income" ? "🟢 Pemasukan" : "🔴 Pengeluaran"}</strong> — ${escapeHtml(it.description||"-")}</div>
        <div class="small">${it.date || nowISO()}</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="entryAmount">${fmtCurrency(it.amount)}</div>
        <div class="entryActions">
          <button onclick="editEntry('${it.id}')">✏️</button>
          <button onclick="deleteEntry('${it.id}')">🗑️</button>
        </div>
      </div>
    `;
    entriesListEl.appendChild(card);
  });
  document.getElementById("totalAmount").textContent = fmtCurrency(total);
}

function editEntry(id){
  const list = loadEntries();
  const it = list.find(x=>x.id===id);
  if(!it) return;
  const newDesc = prompt("Ubah deskripsi", it.description || "");
  if(newDesc === null) return;
  const newAmount = parseFloat(prompt("Ubah jumlah", it.amount));
  if(isNaN(newAmount) || newAmount < 0){ toast("Jumlah tidak valid"); return; }
  it.description = newDesc;
  it.amount = newAmount;
  saveEntries(list);
  renderMoneyList();
}

function deleteEntry(id){
  if(!confirm("Hapus item ini?")) return;
  const list = loadEntries().filter(x=>x.id!==id);
  saveEntries(list);
  renderMoneyList();
}

document.getElementById("addBtn").addEventListener("click", ()=>{
  const kind = document.getElementById("kind").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const date = document.getElementById("date").value || nowISO();
  const desc = document.getElementById("desc").value || "";
  if(isNaN(amount) || amount <= 0){ toast("Nominal > 0"); return; }
  const list = loadEntries(); list.push({id:uid(), kind, amount: Number(amount), description: desc, date});
  saveEntries(list);
  document.getElementById("amount").value = "";
  document.getElementById("desc").value = "";
  renderMoneyList();
});
document.getElementById("clearBtn1").addEventListener("click", ()=>{
  if(confirm("Hapus semua catatan keuangan?")){ saveEntries([]); renderMoneyList(); }
});

/* ========== SAVINGS (Slide 2) ========== */
function renderSavings(){
  const list = loadTabungan();
  const tbody = document.querySelector("#slide2Table tbody");
  tbody.innerHTML = "";
  let sum = 0;
  list.forEach(it=>{
    sum += (it.kind === "income" ? Number(it.amount||0) : -Number(it.amount||0));
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${it.date || nowISO()}</td>
                    <td>${it.kind === "income" ? '<span class="badge-income">Pemasukan</span>' : '<span class="badge-expense">Pengeluaran</span>'}</td>
                    <td>${escapeHtml(it.description||"")}</td>
                    <td>${fmtCurrency(it.amount)}</td>
                    <td>
                      <button onclick="editSaving('${it.id}')">✏️</button>
                      <button onclick="deleteSaving('${it.id}')">🗑️</button>
                    </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("slide2Total").textContent = fmtCurrency(sum);
}

document.getElementById("addBtn2").addEventListener("click", ()=>{
  const kind = document.getElementById("kind2").value;
  const amount = parseFloat(document.getElementById("amount2").value);
  const date = document.getElementById("date2").value || nowISO();
  const desc = document.getElementById("desc2").value || "";
  if(isNaN(amount) || amount <= 0){ toast("Nominal > 0"); return; }
  const list = loadTabungan(); list.push({id:uid(), kind, amount: Number(amount), description: desc, date});
  saveTabungan(list);
  document.getElementById("amount2").value = "";
  document.getElementById("desc2").value = "";
  renderSavings();
});
document.getElementById("clearBtn2").addEventListener("click", ()=>{
  if(confirm("Hapus semua tabungan?")){ saveTabungan([]); renderSavings(); }
});

function editSaving(id){
  const list = loadTabungan(); const it = list.find(x=>x.id===id); if(!it) return;
  const newDesc = prompt("Ubah deskripsi", it.description || "");
  if(newDesc === null) return;
  const newAmount = parseFloat(prompt("Ubah jumlah", it.amount));
  if(isNaN(newAmount) || newAmount < 0){ toast("Jumlah tidak valid"); return; }
  it.description = newDesc; it.amount = newAmount;
  saveTabungan(list); renderSavings();
}
function deleteSaving(id){
  if(!confirm("Hapus item ini?")) return;
  const list = loadTabungan().filter(x=>x.id!==id);
  saveTabungan(list); renderSavings();
}

/* ========== TASKS (Slide 3) ========== */
function renderTasks(){
  const list = loadTasks();
  const tbody = document.querySelector("#tasksTable tbody");
  tbody.innerHTML = "";
  // newest first
  list.slice().reverse().forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><input type="checkbox" ${it.done ? "checked" : ""} data-id="${it.id}" class="task-chk"></td>
                    <td>${escapeHtml(it.title)}</td>
                    <td>${it.date || "-"}</td>
                    <td><button data-id="${it.id}" class="task-del">🗑️</button></td>`;
    tbody.appendChild(tr);
  });
  attachTaskHandlers();
}

document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  const title = document.getElementById("taskTitle").value.trim();
  const date = document.getElementById("taskDate").value || "";
  if(!title){ toast("Isi nama tugas!"); return; }
  const list = loadTasks(); list.push({id:uid(), title, date, done:false});
  saveTasks(list);
  document.getElementById("taskTitle").value = ""; document.getElementById("taskDate").value = "";
  renderTasks();
});
document.getElementById("clearTasksBtn").addEventListener("click", ()=>{
  if(confirm("Hapus semua tugas?")){ saveTasks([]); renderTasks(); }
});
function attachTaskHandlers(){
  document.querySelectorAll(".task-chk").forEach(cb=>{
    cb.onchange = ()=>{
      const id = cb.dataset.id;
      const list = loadTasks(); const it = list.find(x=>x.id===id); if(!it) return;
      it.done = cb.checked; saveTasks(list);
    };
  });
  document.querySelectorAll(".task-del").forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      const list = loadTasks().filter(x=>x.id!==id); saveTasks(list); renderTasks();
    };
  });
}

/* ========== PRAY (Slide 4) ========== */
const prayFields = ["subuh","dzuhur","ashar","maghrib","isya"];

function renderPray(){
  const date = document.getElementById("prayDate").value || nowISO();
  const all = loadPray();
  const day = all[date] || {};
  prayFields.forEach(f=>{
    document.getElementById("pray_"+f).value = day[f]?.status || "";
    document.getElementById("note_"+f).value = day[f]?.note || "";
  });
}

function savePrayField(){
  const date = document.getElementById("prayDate").value || nowISO();
  const all = loadPray();
  if(!all[date]) all[date] = {};
  prayFields.forEach(f=>{
    all[date][f] = {
      status: document.getElementById("pray_"+f).value,
      note: document.getElementById("note_"+f).value
    };
  });
  savePray(all);
}

prayFields.forEach(f=>{
  document.getElementById("pray_"+f).addEventListener("change", savePrayField);
  document.getElementById("note_"+f).addEventListener("input", savePrayField);
});

document.getElementById("prayDate").addEventListener("change", renderPray);
document.getElementById("clearPrayForDate").addEventListener("click", ()=>{
  const date = document.getElementById("prayDate").value || nowISO();
  const all = loadPray();
  if(all[date] && confirm("Reset catatan sholat untuk " + date + " ?")){
    all[date] = {};
    savePray(all);
    renderPray();
  }
});

/* ========== EXPORT / IMPORT CSV ========== */
function exportCSV(){
  const rows = [];
  // header: type,date,kind,amount,description,title,done,subuh,note_subuh,dzuhur,note_dzuhur,ashar,note_ashar,maghrib,note_maghrib,isya,note_isya
  rows.push([
    "type","date","kind","amount","description","title","done",
    "subuh","note_subuh","dzuhur","note_dzuhur","ashar","note_ashar","maghrib","note_maghrib","isya","note_isya"
  ]);

  // keuangan
  loadEntries().forEach(it => 
    rows.push(["money", it.date||"", it.kind||"", it.amount||"", it.description||"", "","",
      "","","","","","","","","",""])
  );

  // tabungan
  loadTabungan().forEach(it => 
    rows.push(["saving", it.date||"", it.kind||"", it.amount||"", it.description||"", "","",
      "","","","","","","","","",""])
  );

  // tugas
  loadTasks().forEach(it => 
    rows.push(["task", it.date||"", "","", "", it.title||"", it.done ? "true" : "false",
      "","","","","","","","","",""])
  );

  // sholat
  const pray = loadPray();
  Object.keys(pray).forEach(d=>{
    const p = pray[d];
    rows.push([
      "pray", d, "","","","","",
      p.subuh?.status || "", p.subuh?.note || "",
      p.dzuhur?.status || "", p.dzuhur?.note || "",
      p.ashar?.status || "", p.ashar?.note || "",
      p.maghrib?.status || "", p.maghrib?.note || "",
      p.isya?.status || "", p.isya?.note || ""
    ]);
  });

  const csv = rows.map(r => r.map(c => `"${String(c===undefined?"":c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a"); 
  a.href = URL.createObjectURL(blob); 
  a.download = "glitch-data.csv"; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
  toast("Export CSV berhasil (cek folder Download)");
}

// IMPORT
document.getElementById("fileInput").addEventListener("change", function(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const txt = reader.result.replace(/\r/g,"");
    const lines = txt.split("\n").filter((l,i)=>l.trim()!=="" && i!==0); // skip header
    const money=[], saving=[], tasks=[], prayObj = {};
    for(const line of lines){
      const cols = parseCsvLine(line);
      const type = (cols[0]||"").trim();
      if(type === "money"){
        money.push({id:uid(), date:cols[1]||nowISO(), kind:cols[2]||"income", amount:parseFloat(cols[3]||0), description:cols[4]||""});
      } else if(type === "saving"){
        saving.push({id:uid(), date:cols[1]||nowISO(), kind:cols[2]||"income", amount:parseFloat(cols[3]||0), description:cols[4]||""});
      } else if(type === "task"){
        tasks.push({id:uid(), date:cols[1]||"", title:cols[5]||"", done:(cols[6]==="true")});
      } else if(type === "pray"){
        const d = cols[1]||nowISO();
        prayObj[d] = {
          subuh: {status: cols[7]||"", note: cols[8]||""},
          dzuhur:{status: cols[9]||"", note: cols[10]||""},
          ashar: {status: cols[11]||"", note: cols[12]||""},
          maghrib:{status: cols[13]||"", note: cols[14]||""},
          isya:  {status: cols[15]||"", note: cols[16]||""}
        };
      }
    }

    if(confirm("Import akan menimpa data lama (OK = timpa semua, Batal = gabung).")){
      saveEntries(money);
      saveTabungan(saving);
      saveTasks(tasks);
      savePray(prayObj);
    } else {
      saveEntries( loadEntries().concat(money) );
      saveTabungan( loadTabungan().concat(saving) );
      saveTasks( loadTasks().concat(tasks) );
      const existingPray = loadPray();
      Object.assign(existingPray, prayObj);
      savePray(existingPray);
    }
    renderMoneyList(); renderSavings(); renderTasks(); renderPray();
    toast("Import selesai");
    document.getElementById("fileInput").value = "";
  };
  reader.readAsText(f);
});

/* CSV helper to parse one line with quoted fields */
function parseCsvLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(inQuotes){
      if(ch === '"'){
        if(line[i+1] === '"'){ cur += '"'; i++; } else { inQuotes = false; }
      } else { cur += ch; }
    } else {
      if(ch === ','){ out.push(cur); cur = ""; }
      else if(ch === '"'){ inQuotes = true; }
      else { cur += ch; }
    }
  }
  out.push(cur);
  return out;
}

/* ========== INIT & UTIL ========== */
function initAll(){
  // set default dates
  const today = nowISO();
  if(!document.getElementById("date").value) document.getElementById("date").value = today;
  if(!document.getElementById("date2").value) document.getElementById("date2").value = today;
  if(!document.getElementById("taskDate").value) document.getElementById("taskDate").value = "";
  if(!document.getElementById("prayDate").value) document.getElementById("prayDate").value = today;

  renderMoneyList();
  renderSavings();
  renderTasks();
  renderPray();
}

/* small escape helper */
function escapeHtml(s){
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* run init on load (if already unlocked - not necessary) */
document.addEventListener("DOMContentLoaded", ()=>{
  // nothing here; wait for PIN
});
</script>
</body>
</html>